# SSD 模拟器架构设计文档

## 1. 项目概述

### 1.1 目标
构建一个运行在服务器上的高性能SSD模拟器，通过CPU多核模拟实际SSD主控的行为，支持完整的NVMe协议栈和PCIe接口。

### 1.2 核心特性
- 多核CPU模拟SSD主控核心
- 完整的核间调度与通信机制
- DDR内存管理
- NAND Flash行为模拟
- PCIe/NVMe协议支持
- 块设备接口（支持fio等工具）

---

## 2. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Host Application                               │
│                         (fio, dd, nvme-cli)                             │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          NVMe Driver Layer                               │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │ Admin Queue │  │  IO Queue 0 │  │  IO Queue 1 │  │  IO Queue N │   │
│  │   (SQ/CQ)   │  │   (SQ/CQ)   │  │   (SQ/CQ)   │  │   (SQ/CQ)   │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         PCIe Transport Layer                             │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │              PCIe Endpoint Controller (模拟)                     │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │    │
│  │  │ Config Space│  │  BAR0/1    │  │    DMA Controller       │ │    │
│  │  │   (4KB)     │  │ (MMIO)     │  │                         │ │    │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                      SSD Controller Core (多核架构)                       │
│                                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │   Core 0    │  │   Core 1    │  │   Core 2    │  │   Core N    │    │
│  │  (FrontEnd) │  │  (FTL Core) │  │  (GC/WL)    │  │ (Background)│    │
│  │             │  │             │  │             │  │             │    │
│  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │    │
│  │ │Command  │ │  │ │L2P Map  │ │  │ │GC Mgmt  │ │  │ │Health   │ │    │
│  │ │Parser   │ │  │ │Manager  │ │  │ │         │ │  │ │Monitor  │ │    │
│  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │    │
│  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │    │
│  │ │Request  │ │  │ │Wear     │ │  │ │WL Mgmt  │ │  │ │BB Mgmt  │ │    │
│  │ │Queue    │ │  │ │Leveling │ │  │ │         │ │  │ │         │ │    │
│  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │
│         │                │                │                │            │
│         └────────────────┴────────────────┴────────────────┘            │
│                          Inter-Core Bus                                  │
│                    (Message Queue + Shared Memory)                       │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     SSD Subsystem Modules                                │
│                                                                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │   DDR Manager   │  │   Cache Manager │  │    Metadata Manager     │  │
│  │                 │  │                 │  │                         │  │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────────────┐ │  │
│  │ │ Buffer Pool │ │  │ │ Read Cache  │ │  │ │ Super Block Table   │ │  │
│  │ │ (Data/Meta) │ │  │ │ (Hot Data)  │ │  │ │                     │ │  │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────────────┘ │  │
│  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │ ┌─────────────────────┐ │  │
│  │ │ Page Alloc  │ │  │ │ Write Buffer│ │  │ │ Translation Table   │ │  │
│  │ │             │ │  │ │ (Flush Mgr) │ │  │ │ (L2P Cache)         │ │  │
│  │ └─────────────┘ │  │ └─────────────┘ │  │ └─────────────────────┘ │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────────────┘  │
│                                                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                     NAND Controller                             │    │
│  │                                                                  │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │    │
│  │  │  Channel 0  │  │  Channel 1  │  │  Channel N  │             │    │
│  │  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │             │    │
│  │  │ │Die 0    │ │  │ │Die 0    │ │  │ │Die 0    │ │             │    │
│  │  │ │Die 1    │ │  │ │Die 1    │ │  │ │Die 1    │ │             │    │
│  │  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │             │    │
│  │  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │             │    │
│  │  │ │NAND Cmd │ │  │ │NAND Cmd │ │  │ │NAND Cmd │ │             │    │
│  │  │ │Queue    │ │  │ │Queue    │ │  │ │Queue    │ │             │    │
│  │  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │             │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘             │    │
│  │                                                                  │    │
│  │  ┌─────────────────────────────────────────────────────────┐    │    │
│  │  │              NAND Flash Simulator                        │    │    │
│  │  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │    │    │
│  │  │  │ Page R/W│  │ Block E │  │ Latency │  │ Error   │    │    │    │
│  │  │  │ Timing  │  │ Timing  │  │ Model   │  │ Inject  │    │    │    │
│  │  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │    │    │
│  │  └─────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 一级子模块划分

### 3.1 核心管理层 (Core Management Layer)
| 模块名 | 功能描述 |
|--------|----------|
| `CoreManager` | 多核生命周期管理、核间拓扑管理、负载均衡 |
| `TaskScheduler` | 任务队列管理、优先级调度、抢占式/协作式调度 |
| `InterCoreComm` | 核间消息传递、共享内存管理、同步原语 |
| `InterruptHandler` | 中断分发、中断聚合、中断屏蔽 |

### 3.2 前端接口层 (FrontEnd Layer)
| 模块名 | 功能描述 |
|--------|----------|
| `NVMeController` | NVMe协议解析、命令处理、状态管理 |
| `PCIeEndpoint` | PCIe配置空间、BAR空间、TLP处理 |
| `DMAEngine` | DMA描述符处理、 Scatter-Gather、地址转换 |
| `CommandParser` | 命令解析、验证、分发到各子系统 |

### 3.3 FTL核心层 (Flash Translation Layer)
| 模块名 | 功能描述 |
|--------|----------|
| `L2PManager` | 逻辑到物理地址映射、映射表缓存、持久化 |
| `PPAManager` | 物理页分配、块分配、空块池管理 |
| `SuperBlockMgr` | 超级块管理、RAID-like条带管理 |
| `MetadataManager` | 元数据管理、日志系统、崩溃恢复 |

### 3.4 后端存储层 (BackEnd Layer)
| 模块名 | 功能描述 |
|--------|----------|
| `NANDController` | NAND时序控制、命令下发、状态轮询 |
| `NANDSimulator` | NAND行为模拟、延迟模拟、错误注入 |
| `ChannelScheduler` | 通道调度、命令重排序、并行优化 |
| `DieManager` | Die级别管理、Plane交错、页缓存 |

### 3.5 内存管理层 (Memory Management Layer)
| 模块名 | 功能描述 |
|--------|----------|
| `DDRManager` | DDR分配/释放、内存池、对齐管理 |
| `BufferPool` | 数据缓冲区池、元数据缓冲区池 |
| `CacheManager` | 读写缓存、缓存策略(LRU/LFU)、Flush管理 |
| `WriteBuffer` | 写缓冲聚合、顺序写优化、回刷策略 |

### 3.6 后台管理层 (Background Layer)
| 模块名 | 功能描述 |
|--------|----------|
| `GarbageCollector` | GC策略、Victim选择、数据迁移 |
| `WearLeveling` | 磨损均衡、冷热数据分离、寿命管理 |
| `BadBlockManager` | 坏块检测、坏块表管理、备用块分配 |
| `HealthMonitor` | 健康状态监控、温度模拟、寿命预测 |

### 3.7 主机接口层 (Host Interface Layer)
| 模块名 | 功能描述 |
|--------|----------|
| `BlockDevice` | Linux块设备接口、VFS集成、IO调度 |
| `SPDKIntegration` | SPDK bdev集成、轮询模式、零拷贝 |
| `IOTracer` | IO跟踪、性能统计、延迟分析 |
| `DebugInterface` | 调试接口、日志系统、性能计数器 |

---

## 4. 数据流图

### 4.1 读IO路径
```
Host Read Request
       │
       ▼
┌─────────────┐
│  NVMe Parse │ ──► 解析Namespace, LBA, Length
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   DMA Setup │ ──► 准备PRP/SGL, 主机内存映射
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  L2P Lookup │ ──► 逻辑地址转物理地址
└──────┬──────┘
       │
       ▼
┌─────────────┐     ┌─────────────┐
│ Cache Check │────►│ Cache Hit   │──► DMA Read from Cache ──► Complete
└──────┬──────┘     └─────────────┘
       │ Miss
       ▼
┌─────────────┐
│ NAND Read   │ ──► 下发Read命令到NAND模拟器
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Data Return │ ──► 更新Cache, DMA到主机
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  Complete   │ ──► 回写CQ, 发送中断
└─────────────┘
```

### 4.2 写IO路径
```
Host Write Request
       │
       ▼
┌─────────────┐
│  NVMe Parse │ ──► 解析Namespace, LBA, Length
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  DMA Read   │ ──► 从主机内存DMA数据到DDR
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Write Buffer│ ──► 聚合写入, 顺序化优化
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  L2P Alloc  │ ──► 分配新物理页, 更新映射表
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ NAND Program│ ──► 下发Program命令
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ Old Page    │ ──► 标记旧页为Invalid
│ Invalidate  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   Complete  │ ──► 回写CQ, 发送中断
└─────────────┘
```

---

## 5. 关键技术决策

### 5.1 多核架构
- **SMP架构**: 对称多处理，各核心功能可配置
- **NUMA感知**: 考虑现代CPU的NUMA特性，优化内存访问
- **核间通信**: 基于Lock-Free Ring Buffer的消息队列

### 5.2 调度策略
- **IO路径**: Work Stealing算法，负载均衡
- **后台任务**: 优先级调度，保证IO性能
- **实时性**: 支持硬实时和软实时任务

### 5.3 缓存策略
- **多级缓存**: L1(核内) -> L2(共享) -> NAND
- **预读策略**: 顺序检测，智能预读
- **写合并**: 页级合并，减少NAND写入

### 5.4 NAND模拟
- **时序精确**: 模拟真实NAND的时序特性
- **并行度**: 支持多Channel, Multi-Die并行
- **特性模拟**: SLC/TLC/QLC模式，ONFI/Toggle协议

---

## 6. 配置文件示例

```yaml
# ssd_config.yaml
system:
  num_cores: 8                    # 模拟核心数
  core_frequency: 1000000000      # 1GHz
  tick_resolution: 1000           # 1ns

pcie:
  version: "4.0"                  # PCIe版本
  lanes: 4                        # 通道数
  max_payload: 256                # Max Payload Size

nvme:
  num_namespaces: 1
  namespace_size: 1099511627776   # 1TB
  sector_size: 512
  mdts: 8                         # Max Data Transfer Size
  
ddr:
  capacity: 4294967296            # 4GB
  bandwidth: 12800000000          # 12.8GB/s
  latency: 100                    # 100ns

cache:
  read_cache_size: 268435456      # 256MB
  write_buffer_size: 536870912    # 512MB
  flush_threshold: 80             # %

nand:
  num_channels: 8
  dies_per_channel: 4
  planes_per_die: 2
  blocks_per_plane: 1024
  pages_per_block: 384
  page_size: 16384                # 16KB
  oob_size: 1664                  # 16KB+1664B
  
  # Timing (microseconds)
  t_read: 60
  t_prog: 600
  t_erase: 3000
  
  # Reliability
  p_erase_limit: 3000             # PE Cycles
  bit_error_rate: 0.0001
```

---

## 7. 下一步计划

### Step 1: 通用模块设计 (已完成架构，待详细设计)
- TaskScheduler: 任务调度器详细设计
- InterCoreComm: 核间通信机制设计
- DDRManager: 内存管理器设计
- MetadataManager: 元数据管理设计

### Step 2: 专有模块设计
- L2PManager: 地址映射模块
- NANDSimulator: NAND行为模拟
- PCIeController: PCIe传输层
- NVMeModule: NVMe协议处理

### Step 3: 实现与验证
- 各模块独立实现
- 单元测试(UT)
- 模块集成测试

### Step 4: 系统集成
- 全链路联调
- 块设备驱动
- fio性能测试

---

**文档版本**: 1.0  
**创建日期**: 2026-02-06  
**状态**: 架构设计阶段
